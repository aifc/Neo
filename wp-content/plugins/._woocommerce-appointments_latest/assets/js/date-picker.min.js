jQuery(document).ready(function(a){"use strict";var b,c,d=wc_appointment_form_params.appointment_duration,e=d<1?1:d,f=e,g=[],h={init:function(){a("body").on("change","#wc_appointments_field_staff",this.date_picker_init),a(".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date").show(),a("body").on("input",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.input_date_trigger),a(".wc-appointments-date-picker").each(function(){var b=a(this).closest("form"),c=b.find(".picker"),d=a(this).closest("fieldset");h.date_picker_init(c),a(".wc-appointments-date-picker-date-fields",d).hide(),a(".wc-appointments-date-picker-choose-date",d).hide()})},date_picker_init:function(b){var c=a(b);c=a(b).is(".picker")?a(b):a(this).closest("form").find(".picker"),null!==get_querystring("date")&&(is_valid_date(get_querystring("date"))?c.attr("data-default_date",get_querystring("date")):window.alert(wc_appointment_form_params.i18n_date_invalid)),c.empty().removeClass("hasDatepicker").datepicker({dateFormat:a.datepicker.ISO_8601,showWeek:!1,showOn:!1,beforeShowDay:h.is_appointable,onSelect:h.select_date_trigger,minDate:c.data("min_date"),maxDate:c.data("max_date"),defaultDate:c.data("default_date"),numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!0,selectOtherMonths:!0,closeText:wc_appointment_form_params.closeText,currentText:wc_appointment_form_params.currentText,prevText:wc_appointment_form_params.prevText,nextText:wc_appointment_form_params.nextText,monthNames:wc_appointment_form_params.monthNames,monthNamesShort:wc_appointment_form_params.monthNamesShort,dayNames:wc_appointment_form_params.dayNames,dayNamesMin:wc_appointment_form_params.dayNamesShort,firstDay:wc_appointment_form_params.firstDay,gotoCurrent:!0,isRTL:wc_appointment_form_params.isRTL});var d,e,f;if("change"!==b.type&&(null===get_querystring("date")&&wc_appointment_form_params.is_autoselect||null!==get_querystring("date")&&is_valid_date(get_querystring("date"))))if(d=c.find(".ui-datepicker-current-day"),d.hasClass("ui-datepicker-unselectable"))for(var g=1;g<12;g++){if(e=h.find_available_date_within_month(),f=h.filter_selectable_day(a(".ui-state-default"),e),f.length>0){f.click();break}c.find(".ui-datepicker-next").click()}else d.click();else a(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day");var i=c.closest("form"),j=parseInt(i.find("input.appointment_date_year").val(),10),k=parseInt(i.find("input.appointment_date_month").val(),10),l=parseInt(i.find("input.appointment_date_day").val(),10);if(j&&k&&l){var m=new Date(j,k-1,l);c.datepicker("setDate",m)}},filter_selectable_day:function(b,c){return b.filter(function(){return Number(a(this).text())===c})},input_date_trigger:function(){var b=a(this).closest("fieldset"),c=b.find(".picker:eq(0)"),d=parseInt(b.find("input.appointment_date_year").val(),10),e=parseInt(b.find("input.appointment_date_month").val(),10),f=parseInt(b.find("input.appointment_date_day").val(),10);if(d&&e&&f){var g=new Date(d,e-1,f);c.datepicker("setDate",g),b.triggerHandler("date-selected",g)}},select_date_trigger:function(d){var e=a(this).closest("fieldset"),g=e.closest("form"),h=d.split("-"),i=parseInt(h[0],10),j=parseInt(h[1],10),k=parseInt(h[2],10);b=new Date(i,j-1,k),c=new Date(i,j-1,k+(parseInt(f,10)-1)),e.find("input.appointment_to_date_year").val(""),e.find("input.appointment_to_date_month").val(""),e.find("input.appointment_to_date_day").val(""),e.find("input.appointment_date_year").val(h[0]),e.find("input.appointment_date_month").val(h[1]),e.find("input.appointment_date_day").val(h[2]).change(),g.find(".wc-appointments-appointment-form-button").addClass("disabled"),g.triggerHandler("date-selected",d)},is_appointable:function(d){var f=a(this).closest("form"),i=f.find(".picker:eq(0)"),j=a(this).data("availability"),k=a(this).data("default-availability"),l=a(this).data("fully-scheduled-days"),m=a(this).data("unavailable-days"),n=a(this).data("partially-scheduled-days"),o=a(this).data("remaining-scheduled-days"),p=a(this).data("restricted-days"),q=a(this).data("padding-days"),r=a(this).data("discounted-days"),s=wc_appointment_form_params.availability_span,t=wc_appointment_form_params.has_staff,u=wc_appointment_form_params.staff_assignment,v=0,w="",x="",y="";f.find("select#wc_appointments_field_staff").val()>0&&(v=f.find("select#wc_appointments_field_staff").val());var z=new Date(d),A=new Date,B=z.getFullYear(),C=z.getMonth()+1,D=z.getDate(),E=z.getDay(),F=A.getFullYear(),G=A.getMonth()+1,H=A.getDate(),I=B+"-"+C+"-"+D,J=i.datepicker("option","minDate"),K=h.get_relative_date(J);if(w=w+"weekday-"+E+" ",h.get_format_date(z)<h.get_format_date(K)&&0!==parseInt(J))return[!1,"not_appointable",wc_appointment_form_params.i18n_date_unavailable];if(d>=b&&d<=c&&(w+="ui-datepicker-selected-day "),l[I]){if(l[I][0]||l[I][v])return[!1,"fully_scheduled",wc_appointment_form_params.i18n_date_fully_scheduled];("automatic"===u||t&&0===v)&&(w+="partial_scheduled ")}if(m&&m[I]&&m[I][v])return[!1,w+"not_appointable",wc_appointment_form_params.i18n_date_unavailable];if(q&&q[I])return[!1,w+"not_appointable",wc_appointment_form_params.i18n_date_unavailable];if(""+B+C+D<wc_appointment_form_params.current_time)return[!1,w+"not_appointable",wc_appointment_form_params.i18n_date_unavailable];if(p&&void 0===p[E])return[!1,w+"not_appointable",wc_appointment_form_params.i18n_date_unavailable];n&&n[I]&&(("automatic"===u||t&&0===v||n[I][0]||n[I][v])&&(w+="partial_scheduled "),o[I][0]?w=w+"remaining_scheduled_"+o[I][0]+" ":o[I][v]&&(w=w+"remaining_scheduled_"+o[I][v]+" ")),new Date(B,C,D)<new Date(F,G,H)&&(w+="past_day "),void 0!==r&&r[I]&&(w+="discounted_day ",y+=r[I]),"start"===s&&(e=1);var L={start_date:d,number_of_days:e,fully_scheduled_days:l,availability:j,default_availability:k,has_staff:t,staff_id:v,staff_assignment:u},M=h.is_slot_appointable(L);if(M&&e>1&&-1===w.indexOf("past_day"))for(var N=0;N<e;N++){var O=new Date(d);O.setDate(z.getDate()+N);var P=O.getFullYear(),Q=O.getMonth()+1,R=O.getDate();O.getDate()!==z.getDate()&&(g[N]=P+"-"+Q+"-"+R)}return M?(x=w.indexOf("partial_scheduled")>-1?wc_appointment_form_params.i18n_date_partially_scheduled:w.indexOf("discounted_day")>-1?y:w.indexOf("past_day")>-1?wc_appointment_form_params.i18n_date_unavailable:wc_appointment_form_params.i18n_date_available,[M,w+"appointable ",x]):a.inArray(I,g)>-1?[M,w+"not_appointable in_range ",wc_appointment_form_params.i18n_date_available]:[M,l[I]?"fully_scheduled":w+"not_appointable",wc_appointment_form_params.i18n_date_unavailable]},is_slot_appointable:function(b){for(var c=b.default_availability,d=0;d<b.number_of_days;d++){var e=new Date(b.start_date);e.setDate(e.getDate()+d);var f=e.getFullYear(),g=e.getMonth()+1,i=e.getDate(),j=e.getDay(),k=f+"-"+g+"-"+i;0===j&&(j=7);var l={date:e,default_availability:b.default_availability},m=b.availability[b.staff_id];if(c=h.is_staff_available_on_date(l,m),"automatic"===b.staff_assignment&&b.has_staff||0===b.staff_id&&b.has_staff){var n=a.extend({availability:b.availability,fully_scheduled_days:b.fully_scheduled_days},l);c=h.has_available_staff(n)}if(b.fully_scheduled_days[k]&&(b.fully_scheduled_days[k][0]||b.fully_scheduled_days[k][b.staff_id])&&(c=!1),!c)break}return c},is_staff_available_on_date:function(b,c){if("object"!=typeof b||"object"!=typeof c)return!1;var d=b.default_availability,e=b.date.getFullYear(),f=b.date.getMonth()+1,g=b.date.getDate(),h=b.date.getDay(),i=e+"-"+f+"-"+g,j=new Date(e,0,1),k=Math.ceil(((b.date-j)/864e5+j.getDay()+1)/7);if(0===h&&(h=7),b.fully_scheduled_days&&b.fully_scheduled_days[i]&&b.fully_scheduled_days[i][b.staff_id])return!1;var l=[],m=_.range(1,1440,1);return d&&(l=m),a.each(c,function(b,c){var d=c.type,i=c.range;if(a.isArray(i))return!0;try{switch(d){case"months":if(void 0!==i[f])return l=i[f]?m:[],!0;break;case"weeks":if(void 0!==i[k])return l=i[k]?m:[],!0;break;case"days":if(void 0!==i[h])return l=i[h]?m:[],!0;break;case"custom":if(void 0!==i[e][f][g])return l=i[e][f][g]?m:[],!0;break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":var j=parseInt(i.from.split(":")[0]),n=parseInt(i.from.split(":")[1]),o=n+60*j,p=parseInt(i.to.split(":")[0]),q=parseInt(i.to.split(":")[1]),r=q+60*p,s=0===p&&0===q,t=!1,u=h-1==0?7:h-1;if(!s&&r<=o&&i.day===u&&(t=i.day),h===i.day||0===i.day||t===i.day){r<=o&&(p+=24,r=q+60*p);var v=_.range(o,r,1);return l=i.rule?_.union(l,v):_.difference(l,v),!0}break;case"time:range":i=i[e][f][g];var w=parseInt(i.from.split(":")[0]),x=parseInt(i.from.split(":")[1]),y=parseInt(i.to.split(":")[0]),z=parseInt(i.to.split(":")[1]);y<=w&&z<=x&&(y+=24);var A=x+60*w,B=z+60*y,C=_.range(A,B,1);l=i.rule?_.union(l,C):_.difference(l,C)}}catch(a){return!0}}),!_.isEmpty(l)},get_week_number:function(a){var b=new Date(a.getFullYear(),0,1);return Math.ceil(((a-b)/864e5+b.getDay()+1)/7)},has_available_staff:function(a){for(var b in a.availability)if(a.availability.hasOwnProperty(b)){if(0===(b=parseInt(b,10)))continue;var c=a.availability[b];if(a.staff_id=b,h.is_staff_available_on_date(a,c))return!0}return!1},get_format_date:function(a){return a.getFullYear()+"-"+(a.getMonth()+1<10?"0":"")+(a.getMonth()+1)+"-"+(a.getDate()<10?"0":"")+a.getDate()},get_relative_date:function(a){for(var b=new Date,c=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,d=c.exec(a);d;){switch(d[2]||"d"){case"d":case"D":b.setDate(b.getDate()+parseInt(d[1],10));break;case"w":case"W":b.setDate(b.getDate()+7*parseInt(d[1],10));break;case"m":case"M":b.setMonth(b.getMonth()+parseInt(d[1],10));break;case"y":case"Y":b.setYear(b.getFullYear()+parseInt(d[1],10))}d=c.exec(a)}return b},find_available_date_within_month:function(){var b=[];return a.each(a(".appointable:not(.ui-state-disabled)").find(".ui-state-default"),function(c,d){var e=+a(d).text();e&&b.push(e)}),b[0]}};h.init()});