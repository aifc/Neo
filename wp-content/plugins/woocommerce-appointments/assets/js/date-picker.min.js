function get_querystring(a){"use strict";a=a.replace(/[*+?^$.\[\]{}()|\\\/]/g,"\\$&");var b=location.search.match(new RegExp("[?&]"+a+"=([^&]+)(&|$)"));return b&&decodeURIComponent(b[1].replace(/\+/g," "))}function is_valid_date(a){"use strict";var b=a.split("-"),c=parseInt(b[0],10),d=parseInt(b[1],10),e=parseInt(b[2],10),f=new Date(c,d-1,e);return c===f.getFullYear()&&d===f.getMonth()+1&&e===f.getDate()?!0:!1}jQuery(document).ready(function(a){"use strict";var b,c,d=wc_appointment_form_params.appointment_duration,e=1>d?1:d,f=e,g=[],h={init:function(){a("body").on("change","#wc_appointments_field_staff",this.date_picker_init),a(".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date").show(),a(".wc-appointments-date-picker").each(function(){var b=a(this).closest("form"),c=b.find(".picker"),d=a(this).closest("fieldset");h.date_picker_init(c),a(".wc-appointments-date-picker-date-fields",d).hide(),a(".wc-appointments-date-picker-choose-date",d).hide()})},date_picker_init:function(b){var c=a(b);c=a(b).is(".picker")?a(b):a(this).closest("form").find(".picker"),null!==get_querystring("date")&&(is_valid_date(get_querystring("date"))?c.attr("data-default_date",get_querystring("date")):window.alert(wc_appointment_form_params.i18n_date_invalid)),c.empty().removeClass("hasDatepicker").datepicker({dateFormat:a.datepicker.ISO_8601,showWeek:!1,showOn:!1,beforeShowDay:h.is_appointable,onSelect:h.select_date_trigger,minDate:c.data("min_date"),maxDate:c.data("max_date"),defaultDate:c.data("default_date"),numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!1,selectOtherMonths:!1,closeText:wc_appointment_form_params.closeText,currentText:wc_appointment_form_params.currentText,prevText:wc_appointment_form_params.prevText,nextText:wc_appointment_form_params.nextText,monthNames:wc_appointment_form_params.monthNames,monthNamesShort:wc_appointment_form_params.monthNamesShort,dayNames:wc_appointment_form_params.dayNames,dayNamesMin:wc_appointment_form_params.dayNamesShort,firstDay:wc_appointment_form_params.firstDay,gotoCurrent:!0});var d;null!==get_querystring("date")&&"change"!==b.type&&is_valid_date(get_querystring("date"))?(d=c.find(".ui-datepicker-current-day"),d.length>0?d.click():d.next().click()):"yes"===wc_appointment_form_params.is_autoselect&&"change"!==b.type&&null===get_querystring("date")?(d=c.find(".ui-datepicker-current-day"),d.hasClass("ui-datepicker-unselectable")?d.next().click():d.click()):a(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day");var e=c.closest("form"),f=parseInt(e.find("input.appointment_date_year").val(),10),g=parseInt(e.find("input.appointment_date_month").val(),10),i=parseInt(e.find("input.appointment_date_day").val(),10);if(f&&g&&i){var j=new Date(f,g-1,i);c.datepicker("setDate",j)}},select_date_trigger:function(d){var e=a(this).closest("fieldset"),g=e.closest("form"),h=d.split("-"),i=parseInt(h[0],10),j=parseInt(h[1],10),k=parseInt(h[2],10);b=new Date(i,j-1,k),c=new Date(i,j-1,k+(parseInt(f,10)-1)),e.find("input.appointment_to_date_year").val(""),e.find("input.appointment_to_date_month").val(""),e.find("input.appointment_to_date_day").val(""),e.find("input.appointment_date_year").val(h[0]),e.find("input.appointment_date_month").val(h[1]),e.find("input.appointment_date_day").val(h[2]).change(),g.triggerHandler("date-selected",d)},is_appointable:function(d){var f=a(this).closest("form"),i=a(this).data("availability"),j=a(this).data("default-availability"),k=a(this).data("fully-scheduled-days"),l=a(this).data("partially-scheduled-days"),m=a(this).data("remaining-scheduled-days"),n=a(this).data("padding-days"),o=a(this).data("discounted-days"),p=wc_appointment_form_params.availability_span,q=wc_appointment_form_params.has_staff,r=wc_appointment_form_params.staff_assignment,s=0,t="",u="",v="";f.find("select#wc_appointments_field_staff").val()>0&&(s=f.find("select#wc_appointments_field_staff").val());var w=new Date(d),x=new Date,y=w.getFullYear(),z=w.getMonth()+1,A=w.getDate(),B=x.getFullYear(),C=x.getMonth()+1,D=x.getDate();if(k[y+"-"+z+"-"+A]&&(k[y+"-"+z+"-"+A][0]||k[y+"-"+z+"-"+A][s]))return[!1,"fully_scheduled",wc_appointment_form_params.i18n_date_fully_scheduled];if(n&&n[y+"-"+z+"-"+A])return[!1,"not_appointable",wc_appointment_form_params.i18n_date_unavailable];if(""+y+z+A<wc_appointment_form_params.current_time)return[!1,"not_appointable",wc_appointment_form_params.i18n_date_unavailable];l&&l[y+"-"+z+"-"+A]&&((l[y+"-"+z+"-"+A][0]||l[y+"-"+z+"-"+A][s])&&(t+="partial_scheduled "),m[y+"-"+z+"-"+A][0]?t=t+"remaining_scheduled_"+m[y+"-"+z+"-"+A][0]+" ":m[y+"-"+z+"-"+A][s]&&(t=t+"remaining_scheduled_"+m[y+"-"+z+"-"+A][s]+" ")),d>=b&&c>=d&&(t="ui-datepicker-selected-day"),new Date(y,z,A)<new Date(B,C,D)&&(t+=" past_day"),"undefined"!=typeof o&&o[y+"-"+z+"-"+A]&&(t+=" discounted_day",v+=o[y+"-"+z+"-"+A]),"start"===p&&(e=1);var E={start_date:d,number_of_days:e,fully_scheduled_days:k,availability:i,default_availability:j,has_staff:q,staff_id:s,staff_assignment:r},F=h.is_slot_appointable(E);if(F&&e>1&&-1===t.indexOf("past_day"))for(var G=0;e>G;G++){var H=new Date(d);H.setDate(w.getDate()+G);var I=H.getFullYear(),J=H.getMonth()+1,K=H.getDate();H.getDate()!==w.getDate()&&(g[G]=I+"-"+J+"-"+K)}return F?(u=t.indexOf("partial_scheduled")>-1?wc_appointment_form_params.i18n_date_partially_scheduled:t.indexOf("discounted_day")>-1?v:t.indexOf("past_day")>-1?wc_appointment_form_params.i18n_date_unavailable:wc_appointment_form_params.i18n_date_available,[F,t+" appointable",u]):a.inArray(y+"-"+z+"-"+A,g)>-1?[F,t+" not_appointable in_range",wc_appointment_form_params.i18n_date_available]:[F,t+" not_appointable",wc_appointment_form_params.i18n_date_unavailable]},is_slot_appointable:function(b){for(var c=b.default_availability,d=0;d<b.number_of_days;d++){var e=new Date(b.start_date);e.setDate(e.getDate()+d);var f=e.getFullYear(),g=e.getMonth()+1,i=e.getDate(),j=e.getDay();0===j&&(j=7);var k={date:e,default_availability:b.default_availability},l=b.availability[b.staff_id];if(c=h.is_staff_available_on_date(k,l),"automatic"===b.staff_assignment&&b.has_staff||0===b.staff_id&&b.has_staff){var m=a.extend({availability:b.availability,fully_scheduled_days:b.fully_scheduled_days},k);c=h.has_available_staff(m)}if(b.fully_scheduled_days[f+"-"+g+"-"+i]&&(b.fully_scheduled_days[f+"-"+g+"-"+i][0]||b.fully_scheduled_days[f+"-"+g+"-"+i][b.staff_id])&&(c=!1),!c)break}return c},is_staff_available_on_date:function(b,c){var d=b.default_availability,e=!1,f=!1,g=!1,h=!1,i=b.date.getFullYear(),j=b.date.getMonth()+1,k=b.date.getDate(),l=b.date.getDay(),m=a.datepicker.iso8601Week(b.date);return 0===l&&(l=7),b.fully_scheduled_days&&b.fully_scheduled_days[i+"-"+j+"-"+k]&&b.fully_scheduled_days[i+"-"+j+"-"+k][b.staff_id]?!1:(a.each(c,function(c,d){var n=d.type,o=d.range;if(a.isArray(o))return!0;try{switch(n){case"months":if("undefined"!=typeof o[j])return e=o[j],f=!0,!0;break;case"weeks":if("undefined"!=typeof o[m])return e=o[m],f=!0,!0;break;case"days":if("undefined"!=typeof o[l])return e=o[l],f=!0,!0;break;case"custom":if("undefined"!=typeof o[i][j][k])return e=o[i][j][k],f=!0,!0;break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":if(!1===b.default_availability&&(l===o.day||0===o.day))return g=o.rule,h=!0,!0;break;case"time:range":!1===b.default_availability&&"undefined"!=typeof o[i][j][k]&&(e=!0,f=!0)}}catch(p){return!0}}),f&&e?e:f&&!e?e:!f&&h&&g?g:d)},has_available_staff:function(a){for(var b in a.availability)if(a.availability.hasOwnProperty(b)){if(b=parseInt(b,10),0===b)continue;var c=a.availability[b];if(a.staff_id=b,h.is_staff_available_on_date(a,c))return!0}return!1}};h.init()});